<script src="../../ngrx/actions/history.actions.ts"></script>
<div style="display: flex; width: 100%; height: 100%">
  <div class="page-container">
    <!-- Render a list of cards with different aspect ratios -->
    <!--    <div class="video-actions-wrapper">-->
    <div class="video-cards" #cardsContainer>
      @for (card of cards; track $index) {
        @if (card.aspectRatio) {
          <div class="card-wrapper subItem">


            <div
              #pageContainer
              style="flex: 1; height: 100% ; display: flex; justify-content: center; flex-direction: row; align-items: center; padding: 0 16px"
            >

              <div style="display: flex; flex-direction: row; gap: 8px; width: fit-content; height: fit-content">


                <div class="card" [ngStyle]="getCardBoxStyle(card)">
                  <div class="card-media">
                    <img
                      [src]="convertToSupabaseUrl(card.thumbnailPath, 'thumbnail')"
                      [alt]="card.title || 'Video thumbnail'"
                      style="width:100%;height:100%;object-fit:contain;"
                      [ngStyle]="{display: videoReadyStates[currentVideoIndex] ? 'none' : 'block'}"/>
                    @if (Math.abs($index - currentVideoIndex) <= 2 && $index >= currentVideoIndex - 1) {
                      <app-video
                        [videoId]="card.id"
                        aspectRatio="{{card.aspectRatio}}"
                        [thumbnailPath]="card.thumbnailPath"
                        videoSrc="{{convertToSupabaseUrl(`${card.id}/master.m3u8`,'video')}}"
                        (videoReady)="onVideoReady($index)"
                        [videoIdActivate]="this.cards[currentVideoIndex].id"
                        [ngStyle]="{display: videoReadyStates[currentVideoIndex] ? 'block' : 'none'}">
                      </app-video>
                    } @else {
                      <img
                        [src]="convertToSupabaseUrl(card.thumbnailPath, 'thumbnail')"
                        [alt]="card.title || 'Video thumbnail'"
                        style="width:100%;height:100%;object-fit:cover;"/>
                    }
                  </div>
                </div>

                <div class="btn-wrapper">
                  <button [disabled]="isGettingLikeComment || (isLiking$ | async) || (isGettingLiked$ | async)" mat-fab
                          aria-label="Example icon button with a delete icon"
                          class="heart"
                          [class.active]="videoDetail.isLikedByCurrentUser && !isGettingLikeComment "
                          (click)="videoDetail.isLikedByCurrentUser ? unlikeVideo() : toggleLike()">
                    @if (videoDetail.isLikedByCurrentUser && !isGettingLikeComment) {
                      <mat-icon>favorite</mat-icon>
                    } @else {
                      <mat-icon>favorite_border</mat-icon>
                    }
                  </button>
                  <span
                    [class.is-getting-like-comment]="isGettingLikeComment || (isLiking$ | async) || (isGettingLiked$ | async)">
                    {{ isGettingLikeComment ? '0' : videoDetail.likeCount }}
                  </span>

                  <button [disabled]="isGettingLikeComment && !(isLiking$ | async)" (click)="toggleComments()" mat-fab
                          aria-label="Example icon button with a delete icon">
                    <mat-icon
                      fontSet="material-symbols-outlined"
                    >comment
                    </mat-icon>
                  </button>
                  <span [class.is-getting-like-comment]="isGettingLikeComment">
                    {{ isGettingLikeComment ? '0' : videoDetail.commentCount }}
                  </span>

                  <button
                    [disabled]="(isGettingLikeComment && !(isLiking$ | async)) || (this.isProcessingPlaylist$ | async)"
                    mat-fab
                    aria-label="Example icon button with a delete icon"
                    class="bookmark"
                    [class.active]="videoDetail.isSavedByCurrentUser"
                    (click)="!videoDetail.isSavedByCurrentUser? saveToPlaylist() : removeFromPlaylist()">
                    @if (videoDetail.isSavedByCurrentUser) {
                      <mat-icon>bookmark</mat-icon>
                    } @else {
                      <mat-icon>bookmark_border</mat-icon>
                    }
                  </button>
                  <button mat-fab [routerLink]="['/profile', card.profileId, 'videos']"
                          aria-label="Example icon button with a delete icon" class="avatar-frame">
                    <img
                      src="{{card.profile?.avatarPath | avatar}}"
                      referrerpolicy="no-referrer"
                      alt="">
                  </button>
                </div>
              </div>
            </div>
          </div>
        }

      }
    </div>


    <!--    </div>-->
  </div>

  <!-- Sidebar bình luận -->
  @if (showCommentExpanded) {
    <div class="comment-sidebar">
      <div class="comment-header">
        <mat-icon>chat_bubble_outline</mat-icon>
        <span>Comments</span>
        <button mat-icon-button (click)="toggleComments()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Danh sách comment -->
      <div class="comment-list">
        @for (c of comments; track c.id) {
          <div class="comment">
            <div class="avatar">
              <img src="{{c.profile?.avatarPath | avatar}}" alt="{{c.profile?.avatarPath}}"/>
            </div>
            <div class="comment-content">
              <p><strong>{{ c.profile?.username }}</strong> {{ c.content }}</p>
              <span class="date">{{ c.createdAt | date : "MMM dd, yyyy" }}</span>
            </div>
          </div>
        }
      </div>

      <!-- Form nhập comment -->
      <div class="frame-comment">
        <mat-form-field appearance="outline" class="comment-input">
          <mat-label>Thêm bình luận</mat-label>
          <input
            matInput
            placeholder="Viết bình luận..."
            [(ngModel)]="commentContent"
            (keydown.enter)="createComment()"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="createComment()"
          >
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </div>
  }
</div>
